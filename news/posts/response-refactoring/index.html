<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Response Refactoring | Wire Cell News</title>
<link href="../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link rel="alternate" type="application/rss+xml" title="RSS" href="../../rss.xml">
<link rel="canonical" href="http://wirecell.github.io/news/posts/response-refactoring/">
<!--[if lt IE 9]><script src="../../assets/js/html5.js"></script><![endif]--><meta name="author" content="Brett Viren">
<link rel="prev" href="../pgrapher-configuration-improvements/" title="Pgrapher Configuration Improvements" type="text/html">
<link rel="next" href="../default-config-dumper/" title="Default Config Dumper" type="text/html">
<meta property="og:site_name" content="Wire Cell News">
<meta property="og:title" content="Response Refactoring">
<meta property="og:url" content="http://wirecell.github.io/news/posts/response-refactoring/">
<meta property="og:description" content='In WCT we try to follow the mantra "everything is a component".  One
corollary to that is we try to avoid hard-wiring dependencies by
having functionality accessed by hard-wired construction of concre'>
<meta property="og:type" content="article">
<meta property="article:published_time" content="2018-07-03T18:59:30-04:00">
<meta property="article:tag" content="config">
<meta property="article:tag" content="dfp">
<meta property="article:tag" content="graph">
<meta property="article:tag" content="simulation">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<div class="blog-masthead">
    <div class="container">
<!-- This keeps the margins nice -->
        <nav class="blog-nav" role="navigation"><a href="../../index.html" class="blog-nav-item">Home</a>
            <a href="../../archive.html" class="blog-nav-item">Archive</a>
            <a href="../../categories/" class="blog-nav-item">Tags</a>
            <a href="../../rss.xml" class="blog-nav-item">RSS feed</a>
            <a href="../../" class="blog-nav-item">Manual</a>

            

    <a href="index.org" class="blog-nav-item blog-nav-item-aside" id="sourcelink">Source</a>
                
            
        </nav>
</div>
<!-- /.container -->
</div>
<!-- End of Menubar -->

<div class="container" id="content" role="main">
    <div class="body-content">
        <div class="blog-header">
            <h1 class="blog-title">
                <a href="http://wirecell.github.io/news/">
                    <img src="../../images/wcgh.png" alt="Wire Cell News" id="logo"><span id="blog-title">Wire Cell News</span>
                </a>
            </h1>
            <p class="lead blog-description">Updates on the Wire Cell Toolkit.</p>
            
        </div>
        <!--Body content-->
        <div class="row">
            <div class="col-sm-8 blog-main">
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h2 class="p-name entry-title blog-post-title" itemprop="headline name"><a href="." class="u-url">Response Refactoring</a></h2>

        <div class="metadata blog-post-meta">
            <p class="byline author vcard"><span class="byline-name fn">Brett Viren</span></p>
            <p class="dateline"><a href="." rel="bookmark"><time class="published dt-published" datetime="2018-07-03T18:59:30-04:00" itemprop="datePublished" title="2018-07-03 18:59">2018-07-03 18:59</time></a></p>
                    <p class="sourceline"><a href="index.org" id="sourcelink">Source</a></p>

        </div>
        
    </header><div class="e-content entry-content" itemprop="articleBody text">
    <p>
In WCT we try to follow the mantra "everything is a component".  One
corollary to that is we try to avoid hard-wiring dependencies by
having functionality accessed by hard-wired construction of concrete
classes.  The various classes having to do with responses suffered
from not being available as components.  This led to the entire
toolkit having hard-wired behavior which hampers support for multiple
detectors.  This post describes some recent steps to fix this problem.
</p>

<!-- TEASER_END -->

<div id="outline-container-orgd7d0d1b" class="outline-2">
<h2 id="orgd7d0d1b">Survey of Responses</h2>
<div class="outline-text-2" id="text-orgd7d0d1b">
<p>
There are various responses that matter in LArTPC.  In WCT they include:
</p>

<dl class="org-dl">
<dt>field response</dt>
<dd>a waveform giving induced current for a point
charge drifting along a path determined by some
starting point ("impact position")</dd>
<dt>electronics response</dt>
<dd>strictly referring to the functional form,
parameterized by a gain (in units of Voltage/Charge) and a
shaping (peaking) time which gives a voltage waveform when
convolved with a charge waveform.  This is models the effect of
the BNL cold electronics.</dd>
<dt>rcrc response</dt>
<dd>the RC filters in the MicroBooNE electronics after
the cold amplifier.</dd>
<dt>plane impact response</dt>
<dd>a roll-up of the above and used for
simulation components (<code>Ductor</code> via <code>ImpactZipper</code>)</dd>
</dl>
</div>

<div id="outline-container-org9c4eb98" class="outline-3">
<h3 id="org9c4eb98">Field Response Functions</h3>
<div class="outline-text-3" id="text-org9c4eb98">
<p>
The field response functions (FR) are a large family of waveforms
defined along many impact positions that span (so far) up to +/- 10
wires on either side of the "wire of interest" and defined at 1/10
pitch positions.  These are (currently) calculated by Garfield and
then converted to JSON (see the command <code>wirecell-sigproc
convert-garfield</code>).  Because they represent a lot of detailed data in
a rather specific and not so friendly format it is recommended that
users, for the most part, treat these files as "binary blobs".
</p>

<p>
However, they represent critical data for simulation and signal
processing.  They need to be used by many components.  In order to
avoid loading and reloading the same files they should not be loaded
directly but rather accessed in components by (you guessed it) another
component.  The component interface is <a href="https://github.com/WireCell/wire-cell-iface/blob/master/inc/WireCellIface/IFieldResponse.h#L22"><code>IFieldResponse</code></a> is rather
trivial, providing just one method <code>field_response()</code> which returns a
reference to the top <code>Response::Schema::FieldResponse</code> data structure.  
</p>

<p>
When you need the FR set you should lookup a <code>IFieldResponse</code>
component based on a configuration parameter given to your component:
</p>

<div class="highlight"><pre><span></span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">fr_type_name</span> <span class="o">=</span> <span class="p">...;</span>  <span class="c1">// eg, maybe "FieldResponse:InstanceName"</span>
<span class="k">auto</span> <span class="n">ifr</span> <span class="o">=</span> <span class="n">Factory</span><span class="o">::</span><span class="n">find_tn</span><span class="p">(</span><span class="n">fr_type_name</span><span class="p">);</span>
<span class="k">auto</span> <span class="n">fr</span> <span class="o">=</span> <span class="n">ifr</span><span class="o">-&gt;</span><span class="n">field_response</span><span class="p">();</span>
</pre></div>

<p>
You can then iterate through planes and wires until getting actual
response functions.
</p>
</div>
</div>

<div id="outline-container-org88c058f" class="outline-3">
<h3 id="org88c058f">Electronics Response</h3>
<div class="outline-text-3" id="text-org88c058f">
<p>
The Electronics Response is a single function giving a waveform
parameterized by gain and shaping time.  It has a functional form
defined deep inside <code>wire-cell-util</code> but your component code should
avoid using it directly and instead use an <a href="https://github.com/WireCell/wire-cell-iface/blob/master/inc/WireCellIface/IWaveform.h"><code>IWaveform</code></a> component that
provides it.  With such a component you can get the waveform sample
vector as well as start time and sampling period.
</p>

<p>
The <code>ElecResponse</code> component is currently the only one available and
it takes gain and shaping as well as a relative post shaping gain
(<code>postgain</code>).  Your component may look up a configured version.
Again, your component should take the instance name to use as a
configuration parameter.
</p>

<div class="highlight"><pre><span></span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">er_type_name</span> <span class="o">=</span> <span class="p">...;</span>
<span class="k">auto</span> <span class="n">er</span> <span class="o">=</span> <span class="n">Factory</span><span class="o">::</span><span class="n">find_tn</span><span class="p">(</span><span class="n">er_type_name</span><span class="p">);</span>
<span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">"Tick is "</span> <span class="o">&lt;&lt;</span> <span class="n">er</span><span class="o">-&gt;</span><span class="n">waveform_period</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
<span class="k">auto</span> <span class="n">spec</span> <span class="o">=</span> <span class="n">dft</span><span class="p">(</span><span class="n">er</span><span class="o">-&gt;</span><span class="n">waveform_samples</span><span class="p">());</span> <span class="c1">// do FFT</span>
</pre></div>
</div>
</div>

<div id="outline-container-orgde65cb5" class="outline-3">
<h3 id="orgde65cb5">RC Response</h3>
<div class="outline-text-3" id="text-orgde65cb5">
<p>
The RC response is simply that of an RC circuit.  It's parameterized
by a "width" in units of time.  It also delegates to a hard-wired
function deep in <code>wire-cell-util</code> and your component code should look
it up just like ER.
</p>
</div>
</div>

<div id="outline-container-org31e089b" class="outline-3">
<h3 id="org31e089b">Plane Impact Response</h3>
<div class="outline-text-3" id="text-org31e089b">
<p>
The <a href="https://github.com/WireCell/wire-cell-iface/blob/master/inc/WireCellIface/IPlaneImpactResponse.h">plane impact response (PIR)</a> is a special purpose component which
rolls up the FRs and optionally some number of other responses.  It
performs a convolution of each FR function with all the other response
and gives access to the result on a per-impact basis.  This component
is primarily used by the signal simulation.  It has one implementation
in <code>wire-cell-gen</code> which can be configured with the FR instance name
and a list of instance names for "other" responses.  For simulating
MicroBooNE for the "other" response includes one ER and two RCs (of
the same name so that an RC<sup>2</sup> response is effected).
</p>
</div>
</div>
</div>

<div id="outline-container-orgc3ecefe" class="outline-2">
<h2 id="orgc3ecefe">Why Refactoring?</h2>
<div class="outline-text-2" id="text-orgc3ecefe">
<p>
So, what's with the refactoring?  Well, we used to violate "everything
is a component" guideline with all these responses.  This started
mostly due to laziness in not getting around to making them honest
components.  But there were some misuse of them as well, particularly
with using PIR:
</p>

<ul class="org-ul">
<li>to get some simple configuration parameters that a
component should best be configured directly.  (Eg, why get a giant
PIR with its dependencies just to know how many ticks to make in a
readout?)</li>

<li>for things that the <code>Pimpos</code> class can provide (this class
deserves its own post, and probably should become a component).</li>

<li>to get at the FRs instead of getting them directly.</li>
</ul>
<p>
Also, given the hard-wiring, we were unable to support different
responses as needed to support different detectors (eg, the RC<sup>2</sup> is
MicroBooNE-specific).  This refactoring was needed to break that
hard-wiring.
</p>
</div>
</div>

<div id="outline-container-orgb2d8620" class="outline-2">
<h2 id="orgb2d8620">What now</h2>
<div class="outline-text-2" id="text-orgb2d8620">
<p>
Mostly this refactoring is not a change that users will care about.
However, some things may have broken in the near term.  There are also
now some configuration items that are no longer hard-wired and need to
be supplied in configuration.  Work is ongoing to improve the <a href="https://github.com/wirecell/wire-cell-cfg">official
config examples</a> to catch up with these changes.  By the <a href="https://github.com/orgs/WireCell/projects/1">next release</a>
this will be all sorted.
</p>
</div>
</div>
    </div>
    <aside class="postpromonav"><nav><ul itemprop="keywords" class="tags">
<li><a class="tag p-category" href="../../categories/config/" rel="tag">config</a></li>
            <li><a class="tag p-category" href="../../categories/dfp/" rel="tag">dfp</a></li>
            <li><a class="tag p-category" href="../../categories/graph/" rel="tag">graph</a></li>
            <li><a class="tag p-category" href="../../categories/simulation/" rel="tag">simulation</a></li>
        </ul>
<ul class="pager hidden-print">
<li class="previous">
                <a href="../pgrapher-configuration-improvements/" rel="prev" title="Pgrapher Configuration Improvements">Previous post</a>
            </li>
            <li class="next">
                <a href="../default-config-dumper/" rel="next" title="Default Config Dumper">Next post</a>
            </li>
        </ul></nav></aside></article>
</div>
            <div class="col-sm-3 col-sm-offset-1 blog-sidebar">
                    <div class="sidebar-module sidebar-module-inset">
      <h4>About</h4>
      <p>Wire Cell encompasses a collection of techniques and software implementation for the simulation, noise filtering, signal processing, 3D imaging, pattern recognition and reconstruction of liquid argon time projection chamber detectors.</p>
    </div>
    <div class="sidebar-module">
      <h4>Links</h4>
      <ol class="list-unstyled">
<li><a href="https://www.phy.bnl.gov/wire-cell/">Main Home page</a></li>
        <li><a href="http://wirecell.github.io/">Software Documentation</a></li>
      </ol>
</div>
    
            </div>
        <!--End of body content-->
        </div>
    </div>
</div>

<footer class="blog-footer" id="footer">
    Contents © 2019         <a href="mailto:bv@bnl.gov">Wire Cell Team</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         
    
</footer><script src="../../assets/js/all-nocdn.js"></script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script>
</body>
</html>
